<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Kh·ªâ h√°i tr√°i - √în t·∫≠p To√°n 5</title>
<style>
  :root{
    --bg1:#e9f7ec;
    --bg2:#d8f0d9;
    --wood:#e3c79a;
    --wood-dark:#c89f6a;
    --accent:#2e7d32;
    --popup-width:560px;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family: "Segoe UI", Roboto, Arial, sans-serif;
    background: linear-gradient(180deg,var(--bg1),var(--bg2));
    color:#1f3b2e;
    overflow:hidden;
  }
  header{
    padding:18px 14px 6px;
    text-align:center;
    position:relative;
    z-index:3;
  }
  h1{
    margin:0;
    font-size:26px;
    color:var(--accent);
    letter-spacing:0.5px;
  }
  #score{
    position:fixed;
    top:14px;
    right:18px;
    background: rgba(255,255,255,0.9);
    padding:8px 12px;
    border-radius:12px;
    box-shadow:0 3px 10px rgba(0,0,0,0.08);
    font-weight:700;
    z-index:4;
  }
  .stage{
    width:100%;
    height:calc(100vh - 80px);
    display:flex;
    align-items:center;
    justify-content:center;
    flex-direction:column;
    gap:10px;
    position:relative;
    z-index:2;
  }
  #monkey{
    font-size:84px;
    transition:transform .35s;
    user-select:none;
  }
  .shake{ animation:shake .5s; }
  @keyframes shake{
    0%{ transform:translateX(0) }
    25%{ transform:translateX(-6px) }
    50%{ transform:translateX(6px) }
    75%{ transform:translateX(-6px) }
    100%{ transform:translateX(0) }
  }
  #message{
    font-size:18px;
    font-weight:700;
    color:#214a2f;
    margin-top:0;
  }
  .tree{
    display:grid;
    grid-template-columns: repeat(auto-fit,minmax(64px,1fr));
    gap:18px;
    width:min(760px,92%);
    margin: 10px auto 30px;
    justify-items:center;
    align-items:center;
    z-index:2;
    position:relative;
  }
  .fruit{
    font-size:56px;
    padding:8px;
    border-radius:12px;
    cursor:pointer;
    transition:transform .22s,box-shadow .2s,opacity .6s;
    user-select:none;
    background: rgba(255,255,255,0.6);
    box-shadow:0 4px 12px rgba(0,0,0,0.06);
    width:72px;
    height:72px;
    display:flex;
    align-items:center;
    justify-content:center;
  }
  .fruit:hover{ transform: scale(1.12); box-shadow:0 8px 18px rgba(0,0,0,0.12); }
  .fruit.hidden{ display:none; }
  .fall{ animation:fallDown 1s forwards; }
  @keyframes fallDown{
    0%{ transform:translateY(0) rotate(0deg); opacity:1 }
    100%{ transform:translateY(260px) rotate(60deg); opacity:0 }
  }
  #questionPopup{
    display:none;
    position:fixed;
    inset:0;
    background: rgba(0,0,0,0.45);
    z-index:6;
    align-items:center;
    justify-content:center;
  }
  .popup{
    width:var(--popup-width);
    max-width:94%;
    border-radius:14px;
    padding:18px;
    position:relative;
    box-shadow:0 12px 30px rgba(0,0,0,0.25);
    background: linear-gradient(180deg, rgba(255,255,255,0.95), rgba(255,255,255,0.9));
    border:10px solid var(--wood);
    background-clip: padding-box;
  }
  .popup:before{
    content:"";
    position:absolute;
    inset:10px;
    background:
      repeating-linear-gradient(90deg, rgba(0,0,0,0.02) 0 6px, rgba(255,255,255,0) 6px 12px);
    border-radius:6px;
    pointer-events:none;
  }
  .popup .title{
    font-size:20px;
    color:var(--accent);
    font-weight:800;
    margin:4px 0 10px;
    text-align:left;
  }
  .popup .meta{
    font-size:13px;color:#3a6b4b;margin-bottom:8px;text-align:left;
  }
  .question-text{
    font-size:20px;
    font-weight:800;
    color:#17324a;
    text-align:left;
    line-height:1.35;
    background: linear-gradient(90deg, rgba(255,255,255,0.0), rgba(255,255,255,0.0));
    padding:10px;
    border-radius:8px;
    margin-bottom:12px;
  }
  .controls{ display:flex; gap:10px; align-items:center; justify-content:center; margin-top:6px; flex-wrap:wrap }
  .controls input{
    padding:10px 12px;
    font-size:16px;
    border-radius:8px;
    border:1px solid rgba(0,0,0,0.12);
    width:56%;
  }
  .controls button{
    padding:10px 16px;
    font-size:16px;
    border-radius:8px;
    border:none;
    cursor:pointer;
    background:var(--accent);
    color:white;
    font-weight:700;
  }
  .controls button.secondary{
    background:#8d6e63;color:#fff;
  }
  .progress{ font-size:14px;color:#355; text-align:right; margin-top:6px }
  #winPopup{
    display:none;
    position:fixed; inset:0;
    background: rgba(0,0,0,0.45);
    z-index:8;
    align-items:center; justify-content:center;
  }
  .winCard{
    background:linear-gradient(180deg,#fff,#f7fff7);
    border-radius:14px; padding:22px;
    width:360px; text-align:center; box-shadow:0 10px 30px rgba(0,0,0,0.25)
  }
  .winCard h2{ color:var(--accent); margin:8px 0 6px }
  .winCard p{ margin:8px 0 12px; font-weight:700 }
  .leaf{
    position:fixed; top:-50px; font-size:20px; opacity:0.22;
    transform:translateY(0); pointer-events:none; z-index:1;
    filter: drop-shadow(0 1px 1px rgba(0,0,0,0.06));
    animation:leafFall linear forwards;
  }
  @keyframes leafFall{
    to { transform: translateY(110vh) rotate(360deg); opacity:0; }
  }
  @media(max-width:560px){
    #monkey{ font-size:68px }
    .fruit{ width:62px; height:62px; font-size:46px }
    .question-text{ font-size:18px }
  }
</style>
</head>
<body>

<header>
  <h1>üêµ Kh·ªâ H√°i Tr√°i ‚Äî √în t·∫≠p To√°n 5 (K·∫øt n·ªëi tri th·ª©c)</h1>
</header>

<div id="score">ƒêi·ªÉm: 0</div>

<section class="stage">
  <div id="monkey">üêµ</div>
  <div id="message">Kh·ªâ: Ch·ªçn m·ªôt tr√°i ƒë·ªÉ b·∫Øt ƒë·∫ßu (b√°m s√°t SGK To√°n 5).</div>

  <div class="tree" id="fruit-tree">
    <div class="fruit" data-key="num1">üçé</div>
    <div class="fruit" data-key="order">üçå</div>
    <div class="fruit" data-key="library">üçä</div>
    <div class="fruit" data-key="add1">üçá</div>
    <div class="fruit" data-key="sub1">üçì</div>
    <div class="fruit" data-key="mul1">üçê</div>
    <div class="fruit" data-key="div1">ü•ù</div>
    <div class="fruit" data-key="boxes">üçç</div>
    <div class="fruit" data-key="share">üçë</div>
    <div class="fruit" data-key="tickets">üçâ</div>
    <div class="fruit" data-key="revenue">ü••</div>
  </div>
</section>

<div id="questionPopup" aria-hidden="true">
  <div class="popup" role="dialog" aria-modal="true">
    <div class="title">B√†i t·∫≠p</div>
    <div class="meta" id="metaInfo">Kh·ªëi l∆∞·ª£ng: B√†i √¥n t·∫≠p</div>
    <div class="question-text" id="questionText">...</div>
    <div class="progress" id="progressText"></div>
    <div class="controls">
      <input id="answerInput" placeholder="Nh·∫≠p ƒë√°p √°n t·∫°i ƒë√¢y..." autocomplete="off" />
      <button id="submitBtn">Tr·∫£ l·ªùi</button>
      <button class="secondary" id="closeBtn">ƒê√≥ng</button>
    </div>
  </div>
</div>

<div id="winPopup" aria-hidden="true">
  <div class="winCard">
    <h2>üéâ Ch√∫c m·ª´ng! üéâ</h2>
    <p id="finalScore">B·∫°n ƒë√£ h√°i h·∫øt tr√°i c√¢y!</p>
    <button onclick="restartGame()" style="background:var(--accent);padding:10px 16px;border-radius:8px;color:#fff;border:none;font-weight:700">Ch∆°i l·∫°i</button>
  </div>
</div>

<audio id="soundCorrect" src="https://www.myinstants.com/media/sounds/correct-answer.mp3"></audio>
<audio id="soundWrong" src="https://www.myinstants.com/media/sounds/wrong-buzzer.mp3"></audio>
<audio id="soundClap" src="https://www.myinstants.com/media/sounds/applause.mp3"></audio>

<script>
const questionSets = {
  num1:{ texts:["Vi·∫øt s·ªë hai ngh√¨n kh√¥ng trƒÉm linh b·∫£y m∆∞∆°i lƒÉm b·∫±ng ch·ªØ s·ªë."], answers:["2075"] },
  order:{ texts:["Vi·∫øt c√°c s·ªë sau theo th·ª© t·ª± t·ª´ b√© ƒë·∫øn l·ªõn: 3 408; 3 084; 4 038; 3 804. Ghi k·∫øt qu·∫£ (c√°ch nhau b·∫±ng d·∫•u ph·∫©y)."], answers:["3084,3408,3804,4038"] },
  library:{ texts:["M·ªôt th∆∞ vi·ªán c√≥ 2 345 quy·ªÉn ·ªü t·ªß 1, 3 678 quy·ªÉn ·ªü t·ªß 2. H·ªèi t·ªïng s·ªë s√°ch c·∫£ hai t·ªß l√† bao nhi√™u?"], answers:["6023"] },
  add1:{ texts:["T√≠nh t·ªïng: 4 567 + 3 489"], answers:["8056"] },
  sub1:{ texts:["T√≠nh hi·ªáu: 8 032 ‚àí 4 798"], answers:["3234"] },
  mul1:{ texts:["T√≠nh t√≠ch: 235 √ó 12"], answers:["2820"] },
  div1:{ texts:["T√≠nh th∆∞∆°ng: 9 456 √∑ 24"], answers:["394"] },
  boxes:{ texts:["Tr∆∞·ªùng nh·∫≠n 12 th√πng b√°nh, m·ªói th√πng c√≥ 256 c√°i. H·ªèi c·∫£ tr∆∞·ªùng c√≥ bao nhi√™u c√°i b√°nh?"], answers:["3072"] },
  share:{ texts:["T·ª´ k·∫øt qu·∫£ 3072 c√°i b√°nh ·ªü tr√™n, chia ƒë·ªÅu cho 480 h·ªçc sinh. H·ªèi m·ªói em nh·∫≠n ƒë∆∞·ª£c bao nhi√™u c√°i?"], answers:["6"] },
  tickets:{ texts:["L·ªõp 5A b√°n ƒë∆∞·ª£c 375 v√©, l·ªõp 5B b√°n nhi·ªÅu h∆°n 128 v√©, l·ªõp 5C b√°n √≠t h∆°n 47 v√©. H·ªèi t·ªïng s·ªë v√© c·∫£ ba l·ªõp?"], answers:["1206"] },
  revenue:{ texts:["M·ªói v√© gi√° 8 000 ƒë·ªìng. T·ªïng s·ªë v√© b√°n ƒë∆∞·ª£c l√† 1 206. H·ªèi t·ªïng s·ªë ti·ªÅn c·∫£ ba l·ªõp thu ƒë∆∞·ª£c l√† bao nhi√™u?"], answers:["9648000"] }
};

let currentKey=null, stepIndex=0, score=0;
let fruitsRemaining=document.querySelectorAll('.fruit').length;
const scoreEl=document.getElementById('score');
const monkeyEl=document.getElementById('monkey');
const messageEl=document.getElementById('message');
const popup=document.getElementById('questionPopup');
const questionTextEl=document.getElementById('questionText');
const progressEl=document.getElementById('progressText');
const answerInput=document.getElementById('answerInput');
const submitBtn=document.getElementById('submitBtn');
const closeBtn=document.getElementById('closeBtn');
const winPopup=document.getElementById('winPopup');
const finalScoreEl=document.getElementById('finalScore');
const sCorrect=document.getElementById('soundCorrect');
const sWrong=document.getElementById('soundWrong');
const sClap=document.getElementById('soundClap');

document.querySelectorAll('.fruit').forEach(el=>{
  el.addEventListener('click', ()=> {
    const key = el.getAttribute('data-key');
    openQuestion(key, el);
  });
});

function openQuestion(key, fruitEl){
  if(!questionSets[key]) return;
  currentKey=key; stepIndex=0; showStep();
  popup.style.display='flex';
  popup.setAttribute('aria-hidden','false');
  answerInput.focus();
  monkeyEl.textContent='üêµ‚ùì';
  messageEl.textContent='Kh·ªâ: H√£y tr·∫£ l·ªùi c√¢u h·ªèi ƒë·ªÉ h√°i qu·∫£ n√†y nh√©!';
}

function showStep(){
  const set=questionSets[currentKey];
  questionTextEl.textContent=set.texts[stepIndex]||'...';
  progressEl.textContent=(set.texts.length>1)?`C√¢u ${stepIndex+1} / ${set.texts.length}`:'';
  answerInput.value='';
}

closeBtn.addEventListener('click', closeQuestion);
function closeQuestion(){
  popup.style.display='none';
  popup.setAttribute('aria-hidden','true');
  currentKey=null; stepIndex=0;
}

submitBtn.addEventListener('click', handleSubmit);
answerInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter') handleSubmit(); });

function handleSubmit(){
  if(!currentKey) return;
  const val=answerInput.value.trim();
  const set=questionSets[currentKey];
  const expected=(set.answers[stepIndex]||'').trim();
  if(val===expected){
    score++;
    scoreEl.textContent=`ƒêi·ªÉm: ${score}`;
    sCorrect.currentTime=0; sCorrect.play().catch(()=>{});
    setTimeout(()=>{ sClap.currentTime=0; sClap.play().catch(()=>{}); },200);
    monkeyEl.textContent='üëèüêµüëè'; monkeyEl.classList.add('shake');
    messageEl.textContent='Kh·ªâ: Gi·ªèi l·∫Øm!';
    stepIndex++;
    if(stepIndex<set.texts.length){
      setTimeout(()=> {
        monkeyEl.classList.remove('shake');
        showStep();
        answerInput.focus();
        messageEl.textContent='Kh·ªâ: Ti·∫øp t·ª•c nh√©!';
      },700);
    } else {
      const fruitEl=document.querySelector(`.fruit[data-key="${currentKey}"]`);
      if(fruitEl){
        setTimeout(()=> { fruitEl.classList.add('fall'); fruitsRemaining--; setTimeout(()=>{ fruitEl.style.display='none'; },1000); },350);
      }
      setTimeout(()=> {
        monkeyEl.classList.remove('shake'); popup.style.display='none'; popup.setAttribute('aria-hidden','true');
        currentKey=null; stepIndex=0;
        messageEl.textContent=(fruitsRemaining<=0)?messageEl.textContent:'Kh·ªâ: Ch·ªçn ti·∫øp qu·∫£ kh√°c n√†o!';
        if(fruitsRemaining<=0) showWin();
      },900);
    }
  } else {
    sWrong.currentTime=0; sWrong.play().catch(()=>{});
    monkeyEl.textContent='üòÖüêµ';
    messageEl.textContent='Kh·ªâ: Sai r·ªìi, c·ªë l√™n n√†o! Th·ª≠ l·∫°i nh√©.';
    answerInput.focus();
  }
}

function showWin(){
  finalScoreEl.textContent=`B·∫°n ƒë√£ h√°i h·∫øt tr√°i c√¢y!\nT·ªïng ƒëi·ªÉm: ${score}`;
  winPopup.style.display='flex';
  winPopup.setAttribute('aria-hidden','false');
}

function restartGame(){ location.reload(); }

function createLeaf(){
  const leaf=document.createElement('div');
  leaf.className='leaf'; leaf.textContent='üçÉ';
  leaf.style.left=Math.random()*window.innerWidth+'px';
  leaf.style.fontSize=(14+Math.random()*18)+'px';
  leaf.style.animationDuration=(4+Math.random()*6)+'s';
  document.body.appendChild(leaf);
  setTimeout(()=>leaf.remove(),11000);
}
setInterval(createLeaf,900);

document.addEventListener('keydown',(e)=>{
  if(e.key==='Escape'){
    if(popup.style.display==='flex') closeQuestion();
    else if(winPopup.style.display==='flex') restartGame();
  }
});
</script>
</body>
</html>
